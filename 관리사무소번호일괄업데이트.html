<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì¼ê´„ ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ</title>
    
    <!-- íŒŒë¹„ì½˜ ì˜¤ë¥˜ ë°©ì§€ -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .auth-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #dd6b20;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #4a5568;
        }
        
        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.show {
            display: block;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .cleanup-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .cleanup-warning {
            color: #856404;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .cleanup-actions {
            display: flex;
            gap: 10px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #e6f0ff;
        }
        
        .upload-area.loaded {
            border-color: #28a745;
            background: #f8fff8;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .file-status {
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #155724;
        }
        
        .file-status.show {
            display: block;
        }
        
        .dual-upload {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .preview-section {
            display: none;
        }
        
        .preview-section.show {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card.matched {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .stat-card.similar {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        
        .stat-card.unmatched {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .matching-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .matching-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        .matching-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }
        
        .matching-table tr:hover {
            background: #f8f9fa;
        }
        
        .match-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .match-exact {
            background: #d4edda;
            color: #155724;
        }
        
        .match-similar {
            background: #fff3cd;
            color: #856404;
        }
        
        .match-none {
            background: #f8d7da;
            color: #721c24;
        }
        
        .building-select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .similar-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 5px;
        }
        
        .similar-option {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .similar-option:hover {
            background: #bae7ff;
        }
        
        .progress-section {
            display: none;
        }
        
        .progress-section.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin: 10px 0;
            color: #666;
        }
        
        .log-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-item {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .log-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .log-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .log-info {
            background: #cce7ff;
            color: #004085;
            border-left: 4px solid #007bff;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .sample-format {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .sample-title {
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 10px;
        }
        
        .sample-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .sample-table th,
        .sample-table td {
            border: 1px solid #d9d9d9;
            padding: 8px;
            text-align: left;
        }
        
        .sample-table th {
            background: #fafafa;
            font-weight: 600;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 3000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: #28a745;
        }
        
        .toast.error {
            background: #dc3545;
        }
        
        .toast.warning {
            background: #ffc107;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>
                ğŸ“ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì¼ê´„ ì—…ë°ì´íŠ¸ v2.1
            </h1>
            <div class="auth-section">
                <input type="password" class="auth-input" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" maxlength="6">
                <button class="btn btn-primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content" id="mainContent">
            <!-- ë°ì´í„° ì •ë¦¬ ì„¹ì…˜ -->
            <div class="section cleanup-section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ§¹ ê¸°ì¡´ ë°ì´í„° ì •ë¦¬</h2>
                    <div>
                        <button class="btn btn-warning" onclick="checkExistingData()" id="checkDataBtn">ê¸°ì¡´ ë°ì´í„° í™•ì¸</button>
                        <button class="btn btn-primary" onclick="debugBuildingIds()" id="debugBtn">ğŸ” BuildingID ë””ë²„ê¹…</button>
                    </div>
                </div>
                
                <div class="cleanup-warning">
                    âš ï¸ <strong>ì—…ë°ì´íŠ¸ ì‹œì‘ ì „ ê¸°ì¡´ ë°ì´í„° í™•ì¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</strong><br>
                    ì´ì „ì— ì¤‘ë‹¨ëœ ì—…ë°ì´íŠ¸ë¡œ ì¸í•´ ì¼ë¶€ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ê¸°ì¡´ ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ì •ë¦¬í•˜ì„¸ìš”.
                </div>
                
                <div class="cleanup-actions">
                    <button class="btn btn-danger" onclick="cleanupAllData()" id="cleanupBtn" disabled>ğŸ—‘ï¸ ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì‚­ì œ</button>
                    <button class="btn btn-secondary" onclick="exportExistingData()" id="exportBtn" disabled>ğŸ“¥ ê¸°ì¡´ ë°ì´í„° ë°±ì—…</button>
                </div>
                
                <div id="existingDataInfo" style="display: none; margin-top: 15px;">
                    <!-- ê¸°ì¡´ ë°ì´í„° ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
            
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ</h2>
                    <button class="btn btn-secondary" onclick="downloadSample()">ğŸ“¥ ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                
                <!-- ìƒ˜í”Œ í˜•ì‹ ì•ˆë‚´ -->
                <div class="sample-format">
                    <div class="sample-title">ğŸ“‹ í•„ìš”í•œ íŒŒì¼ 2ê°œ</div>
                    <p style="margin-bottom: 15px;"><strong>1. buildings.json</strong> - ë¹Œë”© ê¸°ì¤€ ë°ì´í„° (ë‹¤ìŒ êµ¬ì¡° ì¤‘ ì•„ë¬´ê±°ë‚˜)</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                        <strong>ì§€ì›ë˜ëŠ” JSON êµ¬ì¡°:</strong><br>
                        â€¢ <code>[{building1}, {building2}, ...]</code> - ë°°ì—´ í˜•íƒœ<br>
                        â€¢ <code>{"buildings": [{building1}, {building2}, ...]}</code> - buildings í‚¤ê°€ ìˆëŠ” ê°ì²´<br>
                        â€¢ <code>{"data": [{building1}, {building2}, ...]}</code> - data í‚¤ê°€ ìˆëŠ” ê°ì²´<br>
                        â€¢ <code>{"key1": {building1}, "key2": {building2}, ...}</code> - í‚¤-ê°’ ê°ì²´ í˜•íƒœ<br>
                        <em>â€» ê° ë¹Œë”© ê°ì²´ëŠ” ë°˜ë“œì‹œ "name" í•„ë“œê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤</em>
                    </div>
                    <p style="margin-bottom: 15px;"><strong>2. ê´€ë¦¬ì‚¬ë¬´ì†Œì •ë³´.xlsx</strong> - ì—…ë°ì´íŠ¸í•  ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ (A~Dì—´)</p>
                    <table class="sample-table">
                        <thead>
                            <tr>
                                <th>Aì—´: ê±´ë¬¼ëª…</th>
                                <th>Bì—´: ë„ë¡œëª…ì£¼ì†Œ</th>
                                <th>Cì—´: ì§€ë²ˆì£¼ì†Œ</th>
                                <th>Dì—´: ê´€ë¦¬ì‚¬ë¬´ì†Œë²ˆí˜¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ë¦¬ë²„íƒ€ì›Œ</td>
                                <td>ì„œìš¸ ì˜ë“±í¬êµ¬ 63ë¡œ 36</td>
                                <td>ì„œìš¸ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™ 61-5</td>
                                <td>02-785-1234</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- ì´ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
                <div class="dual-upload">
                    <!-- buildings.json ì—…ë¡œë“œ -->
                    <div>
                        <h4 style="margin-bottom: 10px; color: #333;">ğŸ¢ buildings.json íŒŒì¼</h4>
                        <div class="upload-area" id="buildingsUploadArea" onclick="document.getElementById('buildingsInput').click()">
                            <div class="upload-icon">ğŸ¢</div>
                            <div class="upload-text">buildings.json íŒŒì¼</div>
                            <div class="upload-hint">ë¹Œë”© ê¸°ì¤€ ë°ì´í„°<br><small>ë°°ì—´/ê°ì²´ êµ¬ì¡° ìë™ ê°ì§€</small></div>
                        </div>
                        <input type="file" id="buildingsInput" class="file-input" accept=".json" onchange="handleBuildingsFile(event)">
                        <div class="file-status" id="buildingsStatus">
                            <strong>âœ… buildings.json ë¡œë“œ ì™„ë£Œ!</strong><br>
                            <span id="buildingsCount">0</span>ê°œì˜ ë¹Œë”© ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                    
                    <!-- ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ -->
                    <div>
                        <h4 style="margin-bottom: 10px; color: #333;">ğŸ“Š ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì—‘ì…€</h4>
                        <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelInput').click()">
                            <div class="upload-icon">ğŸ“Š</div>
                            <div class="upload-text">ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì—‘ì…€</div>
                            <div class="upload-hint">ì§€ì› í˜•ì‹: .xlsx, .xls</div>
                        </div>
                        <input type="file" id="excelInput" class="file-input" accept=".xlsx,.xls" onchange="handleExcelFile(event)">
                        <div class="file-status" id="excelStatus">
                            <strong>âœ… ì—‘ì…€ íŒŒì¼ ë¡œë“œ ì™„ë£Œ!</strong><br>
                            <span id="excelCount">0</span>ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë§¤ì¹­ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ -->
            <div class="section preview-section" id="matchingSection">
                <div class="section-header">
                    <h2 class="section-title">ğŸ” ë¹Œë”© ë§¤ì¹­ ê²°ê³¼</h2>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="startUpdate()" id="updateBtn">ğŸš€ ì—…ë°ì´íŠ¸ ì‹œì‘</button>
                        <button class="btn btn-danger" onclick="clearData()">ğŸ—‘ï¸ ë°ì´í„° ì§€ìš°ê¸°</button>
                    </div>
                </div>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRows">0</div>
                        <div class="stat-label">ì´ ë°ì´í„°</div>
                    </div>
                    <div class="stat-card matched">
                        <div class="stat-number" id="exactMatched">0</div>
                        <div class="stat-label">ì •í™• ë§¤ì¹­</div>
                    </div>
                    <div class="stat-card similar">
                        <div class="stat-number" id="similarMatched">0</div>
                        <div class="stat-label">ìœ ì‚¬ ë§¤ì¹­</div>
                    </div>
                    <div class="stat-card unmatched">
                        <div class="stat-number" id="unmatched">0</div>
                        <div class="stat-label">ë§¤ì¹­ ì•ˆë¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="readyToUpdate">0</div>
                        <div class="stat-label">ì—…ë°ì´íŠ¸ ì¤€ë¹„</div>
                    </div>
                </div>
                
                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="matching-table" id="matchingTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ìˆœë²ˆ</th>
                                <th style="width: 200px;">ì—‘ì…€ ê±´ë¬¼ëª…</th>
                                <th style="width: 150px;">ê´€ë¦¬ì‚¬ë¬´ì†Œë²ˆí˜¸</th>
                                <th style="width: 120px;">ë§¤ì¹­ ìƒíƒœ</th>
                                <th style="width: 250px;">ë§¤ì¹­ëœ ë¹Œë”©</th>
                                <th style="width: 200px;">ë¹Œë”© ì„ íƒ</th>
                            </tr>
                        </thead>
                        <tbody id="matchingTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ì—…ë°ì´íŠ¸ ì§„í–‰ìƒí™© ì„¹ì…˜ -->
            <div class="section progress-section" id="progressSection">
                <div class="section-header">
                    <h2 class="section-title">âš¡ ì—…ë°ì´íŠ¸ ì§„í–‰ìƒí™©</h2>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">ëŒ€ê¸° ì¤‘...</div>
                
                <div class="log-section" id="logSection">
                    <div class="log-item log-info">ì—…ë°ì´íŠ¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div class="toast" id="toast"></div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, remove, update, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyB0jF0Soo-0OoUtJLIIy2g7EMubcHqP5XM",
            authDomain: "rentroll-32a01.firebaseapp.com",
            databaseURL: "https://rentroll-32a01-default-rtdb.firebaseio.com",
            projectId: "rentroll-32a01",
            storageBucket: "rentroll-32a01.appspot.com",
            messagingSenderId: "2538299262",
            appId: "1:2538299262:web:cdf4f01f5dc012e1299d2f"
        };
        
        // ì „ì—­ ë³€ìˆ˜
        window.firebaseApp = null;
        window.database = null;
        window.isAuthenticated = false;
        window.buildingsData = [];
        window.excelData = [];
        window.matchingResults = [];
        window.existingManagementData = {};
        
        // Firebase ì´ˆê¸°í™”
        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.database = getDatabase(window.firebaseApp);
            console.log('Firebase ì—°ê²° ì„±ê³µ');
            
            // Firebase í•¨ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
            window.firebaseRef = ref;
            window.firebasePush = push;
            window.firebaseGet = get;
            window.firebaseSet = set;
            window.firebaseUpdate = update;
            window.firebaseRemove = remove;
            window.firebaseOnValue = onValue;
            
        } catch (error) {
            console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            showToast('Firebase ì—°ê²° ì‹¤íŒ¨. LocalStorage ëª¨ë“œë¡œ ì‹¤í–‰', 'error');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸
        window.adminLogin = function() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === '999999') {
                window.isAuthenticated = true;
                document.getElementById('mainContent').classList.add('show');
                document.getElementById('adminPassword').value = '';
                
                showToast('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
                showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            }
        };
        
        // ê¸°ì¡´ ë°ì´í„° í™•ì¸
        window.checkExistingData = async function() {
            document.getElementById('checkDataBtn').disabled = true;
            document.getElementById('checkDataBtn').textContent = 'í™•ì¸ ì¤‘...';
            
            try {
                window.existingManagementData = {};
                
                if (window.database) {
                    const managementRef = window.firebaseRef(window.database, 'management');
                    const snapshot = await window.firebaseGet(managementRef);
                    
                    if (snapshot.exists()) {
                        window.existingManagementData = snapshot.val();
                    }
                } else {
                    // LocalStorageì—ì„œ ê´€ë¦¬ì‚¬ë¬´ì†Œ ë°ì´í„° ìˆ˜ì§‘
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('management_'));
                    keys.forEach(key => {
                        const buildingId = key.replace('management_', '');
                        const data = JSON.parse(localStorage.getItem(key));
                        window.existingManagementData[buildingId] = data;
                    });
                }
                
                const existingCount = Object.keys(window.existingManagementData).length;
                const infoDiv = document.getElementById('existingDataInfo');
                
                if (existingCount > 0) {
                    infoDiv.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; color: #856404;">
                            <strong>ğŸ“Š ê¸°ì¡´ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ë°œê²¬</strong><br>
                            ì´ <strong>${existingCount}ê°œ</strong>ì˜ ë¹Œë”©ì— ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br><br>
                            <strong>ìµœê·¼ ë“±ë¡ëœ í•­ëª©ë“¤:</strong><br>
                            ${Object.entries(window.existingManagementData)
                                .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0))
                                .slice(0, 5)
                                .map(([buildingId, data]) => 
                                    `â€¢ ${data.buildingName || buildingId}: ${data.phone || 'ì •ë³´ì—†ìŒ'} (${data.author || 'ì‘ì„±ìë¶ˆëª…'})`
                                ).join('<br>')}
                        </div>
                    `;
                    
                    document.getElementById('cleanupBtn').disabled = false;
                    document.getElementById('exportBtn').disabled = false;
                } else {
                    infoDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; color: #155724;">
                            <strong>âœ… ê¸°ì¡´ ë°ì´í„° ì—†ìŒ</strong><br>
                            ê¸°ì¡´ì— ë“±ë¡ëœ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.
                        </div>
                    `;
                    
                    document.getElementById('cleanupBtn').disabled = true;
                    document.getElementById('exportBtn').disabled = true;
                }
                
                infoDiv.style.display = 'block';
                
                showToast(`ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì™„ë£Œ: ${existingCount}ê°œ ë°œê²¬`, existingCount > 0 ? 'warning' : 'success');
                
            } catch (error) {
                console.error('ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì˜¤ë¥˜:', error);
                showToast('ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨', 'error');
            } finally {
                document.getElementById('checkDataBtn').disabled = false;
                document.getElementById('checkDataBtn').textContent = 'ê¸°ì¡´ ë°ì´í„° í™•ì¸';
            }
        };
        
        // ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ë°ì´í„° ì‚­ì œ
        window.cleanupAllData = async function() {
            const count = Object.keys(window.existingManagementData).length;
            if (!confirm(`ì •ë§ë¡œ ${count}ê°œì˜ ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            document.getElementById('cleanupBtn').disabled = true;
            document.getElementById('cleanupBtn').textContent = 'ì‚­ì œ ì¤‘...';
            
            try {
                let deletedCount = 0;
                
                if (window.database) {
                    // Firebaseì—ì„œ ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ë°ì´í„° ì‚­ì œ
                    await window.firebaseRemove(window.firebaseRef(window.database, 'management'));
                    deletedCount = count;
                } else {
                    // LocalStorageì—ì„œ ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ë°ì´í„° ì‚­ì œ
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('management_'));
                    keys.forEach(key => {
                        localStorage.removeItem(key);
                        deletedCount++;
                    });
                }
                
                window.existingManagementData = {};
                
                document.getElementById('existingDataInfo').innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; color: #155724;">
                        <strong>âœ… ë°ì´í„° ì‚­ì œ ì™„ë£Œ</strong><br>
                        ${deletedCount}ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
                    </div>
                `;
                
                document.getElementById('cleanupBtn').disabled = true;
                document.getElementById('exportBtn').disabled = true;
                
                showToast(`${deletedCount}ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
                
            } catch (error) {
                console.error('ë°ì´í„° ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨', 'error');
            } finally {
                document.getElementById('cleanupBtn').textContent = 'ğŸ—‘ï¸ ëª¨ë“  ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ ì‚­ì œ';
            }
        };
        
        // ê¸°ì¡´ ë°ì´í„° ë°±ì—…
        window.exportExistingData = function() {
            if (Object.keys(window.existingManagementData).length === 0) {
                showToast('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(window.existingManagementData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `management_backup_${formatDateForFile(Date.now())}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        };
        
        // buildings.json íŒŒì¼ ì²˜ë¦¬
        window.handleBuildingsFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.json$/)) {
                showToast('JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // ë‹¤ì–‘í•œ JSON êµ¬ì¡° ì²˜ë¦¬
                    if (Array.isArray(jsonData)) {
                        // ì´ë¯¸ ë°°ì—´ í˜•íƒœ: [building1, building2, ...]
                        window.buildingsData = jsonData;
                    } else if (jsonData && typeof jsonData === 'object') {
                        // ê°ì²´ í˜•íƒœ ì²˜ë¦¬
                        if (jsonData.buildings && Array.isArray(jsonData.buildings)) {
                            // {buildings: [building1, building2, ...]} í˜•íƒœ
                            window.buildingsData = jsonData.buildings;
                        } else if (jsonData.data && Array.isArray(jsonData.data)) {
                            // {data: [building1, building2, ...]} í˜•íƒœ
                            window.buildingsData = jsonData.data;
                        } else {
                            // {key1: building1, key2: building2, ...} í˜•íƒœ
                            // ê°ì²´ì˜ ê°’ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜
                            const values = Object.values(jsonData);
                            if (values.length > 0 && values[0] && typeof values[0] === 'object' && values[0].name) {
                                window.buildingsData = values;
                            } else {
                                throw new Error('ë¹Œë”© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                            }
                        }
                    } else {
                        throw new Error('ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');
                    }
                    
                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                    if (!Array.isArray(window.buildingsData) || window.buildingsData.length === 0) {
                        throw new Error('ë¹Œë”© ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                    }
                    
                    // ë¹Œë”© ë°ì´í„° êµ¬ì¡° ê²€ì‚¬ (name í•„ë“œ í•„ìˆ˜)
                    const invalidBuildings = window.buildingsData.filter(building => 
                        !building || typeof building !== 'object' || !building.name
                    );
                    
                    if (invalidBuildings.length > 0) {
                        console.warn(`${invalidBuildings.length}ê°œì˜ ìœ íš¨í•˜ì§€ ì•Šì€ ë¹Œë”© ë°ì´í„°ê°€ ë°œê²¬ë˜ì–´ ì œì™¸ë©ë‹ˆë‹¤.`);
                        window.buildingsData = window.buildingsData.filter(building => 
                            building && typeof building === 'object' && building.name
                        );
                    }
                    
                    if (window.buildingsData.length === 0) {
                        throw new Error('ìœ íš¨í•œ ë¹Œë”© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. name í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                    
                    document.getElementById('buildingsUploadArea').classList.add('loaded');
                    document.getElementById('buildingsStatus').classList.add('show');
                    document.getElementById('buildingsCount').textContent = window.buildingsData.length;
                    
                    // ì²« ë²ˆì§¸ ë¹Œë”© ë°ì´í„° êµ¬ì¡° ë¡œê·¸ (ë””ë²„ê¹…ìš©)
                    console.log('ë¹Œë”© ë°ì´í„° ì²« ë²ˆì§¸ í•­ëª©:', window.buildingsData[0]);
                    console.log('ì „ì²´ ë¹Œë”© ë°ì´í„° ê°œìˆ˜:', window.buildingsData.length);
                    
                    showToast(`${window.buildingsData.length}ê°œì˜ ë¹Œë”© ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤`, 'success');
                    
                    checkBothFilesLoaded();
                    
                } catch (error) {
                    console.error('buildings.json ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showToast(`buildings.json íŒŒì¼ ì˜¤ë¥˜: ${error.message}`, 'error');
                    
                    // ë””ë²„ê¹… ì •ë³´ ì œê³µ
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        console.log('JSON ë°ì´í„° êµ¬ì¡°:', typeof jsonData, Object.keys(jsonData));
                        if (typeof jsonData === 'object' && !Array.isArray(jsonData)) {
                            console.log('ê°ì²´ì˜ í‚¤ë“¤:', Object.keys(jsonData));
                            console.log('ì²« ë²ˆì§¸ ê°’ì˜ êµ¬ì¡°:', Object.keys(Object.values(jsonData)[0] || {}));
                        }
                    } catch (parseError) {
                        console.error('JSON íŒŒì‹± ìì²´ì— ì‹¤íŒ¨:', parseError);
                        showToast('JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
                    }
                }
            };
            
            reader.readAsText(file);
        };
        
        // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
        window.handleExcelFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showToast('ì—‘ì…€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜ (í—¤ë” ì œì™¸)
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: ['buildingName', 'roadAddress', 'lotAddress', 'managementPhone'],
                        range: 1 // ì²« ë²ˆì§¸ í–‰(í—¤ë”) ì œì™¸
                    });
                    
                    window.excelData = jsonData.filter(row => 
                        row.buildingName && row.managementPhone
                    );
                    
                    document.getElementById('excelUploadArea').classList.add('loaded');
                    document.getElementById('excelStatus').classList.add('show');
                    document.getElementById('excelCount').textContent = window.excelData.length;
                    
                    showToast(`${window.excelData.length}ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤`, 'success');
                    
                    checkBothFilesLoaded();
                    
                } catch (error) {
                    console.error('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showToast('ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        };
        
        // ë‘ íŒŒì¼ì´ ëª¨ë‘ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        function checkBothFilesLoaded() {
            if (window.buildingsData.length > 0 && window.excelData.length > 0) {
                performMatching();
                showMatchingResults();
                showToast('ë§¤ì¹­ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤', 'success');
            }
        }
        
        // íŒŒì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸
        setupDragAndDrop('buildingsUploadArea', 'buildingsInput');
        setupDragAndDrop('excelUploadArea', 'excelInput');
        
        function setupDragAndDrop(areaId, inputId) {
            const uploadArea = document.getElementById(areaId);
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const input = document.getElementById(inputId);
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    input.files = dt.files;
                    
                    if (inputId === 'buildingsInput') {
                        handleBuildingsFile({ target: input });
                    } else {
                        handleExcelFile({ target: input });
                    }
                }
            });
        }
        
        // ë¹Œë”© ë§¤ì¹­ ìˆ˜í–‰
        function performMatching() {
            window.matchingResults = [];
            
            window.excelData.forEach((excelRow, index) => {
                const result = {
                    index: index + 1,
                    excelData: excelRow,
                    matchType: 'none',
                    matchedBuilding: null,
                    similarBuildings: [],
                    selectedBuildingId: null,
                    isReady: false
                };
                
                // 1ì°¨: ì •í™•í•œ ê±´ë¬¼ëª… ë§¤ì¹­
                const exactMatch = window.buildingsData.find(building => 
                    building.name.trim().toLowerCase() === excelRow.buildingName.trim().toLowerCase()
                );
                
                if (exactMatch) {
                    result.matchType = 'exact';
                    result.matchedBuilding = exactMatch;
                    result.selectedBuildingId = exactMatch.id;
                    result.isReady = true;
                } else {
                    // 2ì°¨: ìœ ì‚¬í•œ ê±´ë¬¼ëª… ë§¤ì¹­
                    const normalizedExcelName = normalizeString(excelRow.buildingName);
                    const similarBuildings = window.buildingsData.filter(building => {
                        const normalizedBuildingName = normalizeString(building.name);
                        return normalizedBuildingName.includes(normalizedExcelName) || 
                               normalizedExcelName.includes(normalizedBuildingName) ||
                               calculateSimilarity(normalizedExcelName, normalizedBuildingName) > 0.6;
                    });
                    
                    if (similarBuildings.length > 0) {
                        result.matchType = 'similar';
                        result.similarBuildings = similarBuildings;
                        result.matchedBuilding = similarBuildings[0]; // ì²« ë²ˆì§¸ë¥¼ ê¸°ë³¸ìœ¼ë¡œ
                    }
                    
                    // 3ì°¨: ì£¼ì†Œ ë§¤ì¹­ (ë„ë¡œëª…ì£¼ì†Œ)
                    if (similarBuildings.length === 0 && excelRow.roadAddress) {
                        const addressMatch = window.buildingsData.find(building => 
                            building.address && building.address.includes(excelRow.roadAddress.substring(0, 10))
                        );
                        
                        if (addressMatch) {
                            result.matchType = 'similar';
                            result.similarBuildings = [addressMatch];
                            result.matchedBuilding = addressMatch;
                        }
                    }
                    
                    // 4ì°¨: ì£¼ì†Œ ë§¤ì¹­ (ì§€ë²ˆì£¼ì†Œ)
                    if (result.similarBuildings.length === 0 && excelRow.lotAddress) {
                        const lotAddressMatch = window.buildingsData.find(building => 
                            building.addressJibun && building.addressJibun.includes(excelRow.lotAddress.substring(0, 10))
                        );
                        
                        if (lotAddressMatch) {
                            result.matchType = 'similar';
                            result.similarBuildings = [lotAddressMatch];
                            result.matchedBuilding = lotAddressMatch;
                        }
                    }
                }
                
                window.matchingResults.push(result);
            });
        }
        
        // ë¬¸ìì—´ ì •ê·œí™” (ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
        function normalizeString(str) {
            return str.replace(/[\s\-\.]/g, '').toLowerCase();
        }
        
        // ë¬¸ìì—´ ìœ ì‚¬ë„ ê³„ì‚° (ê°„ë‹¨í•œ Levenshtein distance ê¸°ë°˜)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        // Levenshtein distance ê³„ì‚°
        function levenshteinDistance(str1, str2) {
            const matrix = Array(str2.length + 1).fill(null).map(() =>
                Array(str1.length + 1).fill(null));
            
            for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
            for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= str2.length; j++) {
                for (let i = 1; i <= str1.length; i++) {
                    const indicator = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + indicator
                    );
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ
        function showMatchingResults() {
            document.getElementById('matchingSection').classList.add('show');
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            const totalRows = window.matchingResults.length;
            const exactMatched = window.matchingResults.filter(r => r.matchType === 'exact').length;
            const similarMatched = window.matchingResults.filter(r => r.matchType === 'similar').length;
            const unmatched = window.matchingResults.filter(r => r.matchType === 'none').length;
            const readyToUpdate = window.matchingResults.filter(r => r.isReady).length;
            
            document.getElementById('totalRows').textContent = totalRows;
            document.getElementById('exactMatched').textContent = exactMatched;
            document.getElementById('similarMatched').textContent = similarMatched;
            document.getElementById('unmatched').textContent = unmatched;
            document.getElementById('readyToUpdate').textContent = readyToUpdate;
            
            // í…Œì´ë¸” í‘œì‹œ
            const tableBody = document.getElementById('matchingTableBody');
            tableBody.innerHTML = window.matchingResults.map((result, index) => {
                return `
                    <tr style="background-color: ${getMatchColor(result.matchType)};">
                        <td>${result.index}</td>
                        <td>
                            <strong>${result.excelData.buildingName}</strong>
                            ${result.excelData.roadAddress ? `<br><small style="color: #666;">${result.excelData.roadAddress}</small>` : ''}
                        </td>
                        <td>${result.excelData.managementPhone}</td>
                        <td>
                            <span class="match-status match-${result.matchType}">
                                ${getMatchStatusText(result.matchType)}
                            </span>
                        </td>
                        <td>
                            ${result.matchedBuilding ? `
                                <strong>${result.matchedBuilding.name}</strong><br>
                                <small style="color: #666;">${result.matchedBuilding.address}</small>
                            ` : 'ë§¤ì¹­ëœ ë¹Œë”© ì—†ìŒ'}
                            ${result.similarBuildings.length > 1 ? `
                                <div class="similar-options">
                                    ${result.similarBuildings.slice(1, 3).map(building => `
                                        <div class="similar-option" onclick="selectSimilarBuilding(${index}, ${building.id})">
                                            ${building.name}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </td>
                        <td>
                            <select class="building-select" onchange="selectBuilding(${index}, this.value)" ${result.matchType === 'none' ? '' : ''}>
                                <option value="">ë¹Œë”© ì„ íƒ...</option>
                                ${window.buildingsData.map(building => `
                                    <option value="${building.id}" ${result.selectedBuildingId === building.id ? 'selected' : ''}>
                                        ${building.name}
                                    </option>
                                `).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // ì—…ë°ì´íŠ¸ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = readyToUpdate === 0;
        }
        
        // ìœ ì‚¬ ë¹Œë”© ì„ íƒ
        window.selectSimilarBuilding = function(resultIndex, buildingId) {
            const building = window.buildingsData.find(b => b.id === buildingId);
            if (building) {
                window.matchingResults[resultIndex].matchedBuilding = building;
                window.matchingResults[resultIndex].selectedBuildingId = buildingId;
                window.matchingResults[resultIndex].isReady = true;
                showMatchingResults();
            }
        };
        
        // ë¹Œë”© ì„ íƒ
        window.selectBuilding = function(resultIndex, buildingId) {
            if (buildingId) {
                const building = window.buildingsData.find(b => b.id == buildingId);
                if (building) {
                    window.matchingResults[resultIndex].matchedBuilding = building;
                    window.matchingResults[resultIndex].selectedBuildingId = parseInt(buildingId);
                    window.matchingResults[resultIndex].isReady = true;
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    const readyToUpdate = window.matchingResults.filter(r => r.isReady).length;
                    document.getElementById('readyToUpdate').textContent = readyToUpdate;
                    
                    // ì—…ë°ì´íŠ¸ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    const updateBtn = document.getElementById('updateBtn');
                    updateBtn.disabled = readyToUpdate === 0;
                }
            } else {
                window.matchingResults[resultIndex].isReady = false;
                const readyToUpdate = window.matchingResults.filter(r => r.isReady).length;
                document.getElementById('readyToUpdate').textContent = readyToUpdate;
                document.getElementById('updateBtn').disabled = readyToUpdate === 0;
            }
        };
        
        // ë§¤ì¹­ íƒ€ì…ë³„ ìƒ‰ìƒ
        function getMatchColor(matchType) {
            switch(matchType) {
                case 'exact': return '#f8fff8';
                case 'similar': return '#fff8e1';
                case 'none': return '#fff5f5';
                default: return 'white';
            }
        }
        
        // ë§¤ì¹­ ìƒíƒœ í…ìŠ¤íŠ¸
        function getMatchStatusText(matchType) {
            switch(matchType) {
                case 'exact': return 'âœ… ì •í™• ë§¤ì¹­';
                case 'similar': return 'ğŸ” ìœ ì‚¬ ë§¤ì¹­';
                case 'none': return 'âŒ ë§¤ì¹­ ì—†ìŒ';
                default: return 'â“ ë¯¸í™•ì¸';
            }
        }
        
        // ì—…ë°ì´íŠ¸ ì‹œì‘
        window.startUpdate = async function() {
            if (!window.isAuthenticated) {
                showToast('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            const readyData = window.matchingResults.filter(result => result.isReady);
            if (readyData.length === 0) {
                showToast('ì—…ë°ì´íŠ¸í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            if (!confirm(`${readyData.length}ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ì§„í–‰ìƒí™© ì„¹ì…˜ í‘œì‹œ
            document.getElementById('progressSection').classList.add('show');
            document.getElementById('updateBtn').disabled = true;
            
            // ë¡œê·¸ ì´ˆê¸°í™”
            const logSection = document.getElementById('logSection');
            logSection.innerHTML = '';
            
            addLog('ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < readyData.length; i++) {
                const result = readyData[i];
                const building = result.matchedBuilding;
                
                try {
                    // buildingIdëŠ” Firebase ê²½ë¡œ ê·œì¹™ì— ë§ê²Œ ìƒì„± (ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ í˜¸í™˜)
                    // Firebaseì—ì„œ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ë¬¸ìë“¤: . # $ [ ] ( ) ë¥¼ ì•ˆì „í•œ ë¬¸ìë¡œ ë³€í™˜
                    const buildingId = building.name
                        .replace(/\s+/g, '-')           // ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ
                        .replace(/[.#$\[\]()]/g, '_')   // Firebase ê¸ˆì§€ ë¬¸ìë¥¼ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ
                        .replace(/[^a-zA-Z0-9ê°€-í£_-]/g, '_')  // ê¸°íƒ€ íŠ¹ìˆ˜ë¬¸ìë„ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ
                        .replace(/_{2,}/g, '_')         // ì—°ì†ëœ ì–¸ë”ìŠ¤ì½”ì–´ë¥¼ í•˜ë‚˜ë¡œ
                        .replace(/^_|_$/g, '')          // ì‹œì‘/ë ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°
                        .toLowerCase();
                    
                    const managementData = {
                        phone: result.excelData.managementPhone,
                        note: result.excelData.roadAddress ? 
                            `ë„ë¡œëª…: ${result.excelData.roadAddress}${result.excelData.lotAddress ? ', ì§€ë²ˆ: ' + result.excelData.lotAddress : ''}` : '',
                        author: 'system_bulk_update',
                        timestamp: Date.now(),
                        buildingId: buildingId,
                        buildingName: building.name,
                        originalBuildingId: building.id // buildings.jsonì˜ ì›ë³¸ IDë„ ì €ì¥
                    };
                    
                    if (window.database) {
                        await window.firebaseSet(
                            window.firebaseRef(window.database, `management/${buildingId}`),
                            managementData
                        );
                    } else {
                        localStorage.setItem(`management_${buildingId}`, JSON.stringify(managementData));
                    }
                    
                    successCount++;
                    addLog(`âœ… ${building.name} (${result.excelData.buildingName}) â†’ ${buildingId} - ì—…ë°ì´íŠ¸ ì™„ë£Œ`, 'success');
                    
                } catch (error) {
                    errorCount++;
                    addLog(`âŒ ${building.name} (${result.excelData.buildingName}) - ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                    console.error('ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                }
                
                // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
                const progress = ((i + 1) / readyData.length) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = 
                    `ì§„í–‰ì¤‘... ${i + 1}/${readyData.length} (ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${errorCount})`;
                
                // ì ì‹œ ëŒ€ê¸° (ê³¼ë¶€í•˜ ë°©ì§€)
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // ì™„ë£Œ ë©”ì‹œì§€
            addLog(`ğŸ‰ ì—…ë°ì´íŠ¸ ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${errorCount}ê°œ`, successCount > 0 ? 'success' : 'error');
            document.getElementById('progressText').textContent = 
                `ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${errorCount}ê°œ`;
            
            document.getElementById('updateBtn').disabled = false;
            
            if (successCount > 0) {
                showToast(`${successCount}ê°œì˜ ê´€ë¦¬ì‚¬ë¬´ì†Œ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
            }
            if (errorCount > 0) {
                showToast(`${errorCount}ê°œì˜ ë°ì´í„° ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤`, 'error');
            }
        };
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type) {
            const logSection = document.getElementById('logSection');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logSection.appendChild(logItem);
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            logSection.scrollTop = logSection.scrollHeight;
        }
        
        // ë°ì´í„° ì§€ìš°ê¸°
        window.clearData = function() {
            if (confirm('ëª¨ë“  ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.buildingsData = [];
                window.excelData = [];
                window.matchingResults = [];
                
                document.getElementById('matchingSection').classList.remove('show');
                document.getElementById('progressSection').classList.remove('show');
                document.getElementById('buildingsInput').value = '';
                document.getElementById('excelInput').value = '';
                document.getElementById('buildingsUploadArea').classList.remove('loaded');
                document.getElementById('excelUploadArea').classList.remove('loaded');
                document.getElementById('buildingsStatus').classList.remove('show');
                document.getElementById('excelStatus').classList.remove('show');
                
                showToast('ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'success');
            }
        };
        
        // ìƒ˜í”Œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        window.downloadSample = function() {
            const sampleData = [
                ['ê±´ë¬¼ëª…', 'ë„ë¡œëª…ì£¼ì†Œ', 'ì§€ë²ˆì£¼ì†Œ', 'ê´€ë¦¬ì‚¬ë¬´ì†Œë²ˆí˜¸'],
                ['ë¦¬ë²„íƒ€ì›Œ', 'ì„œìš¸ ì˜ë“±í¬êµ¬ 63ë¡œ 36', 'ì„œìš¸ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™ 61-5', '02-785-1234'],
                ['63ë¹Œë”©', 'ì„œìš¸ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™ 60', 'ì„œìš¸ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™ 60', '02-789-5663'],
                ['ì‚¼ì„±ë™ ì½”ì—‘ìŠ¤', 'ì„œìš¸ ê°•ë‚¨êµ¬ ì˜ë™ëŒ€ë¡œ 513', 'ì„œìš¸ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™ 159', '02-6000-0114'],
                ['ë¡¯ë°ì›”ë“œíƒ€ì›Œ', 'ì„œìš¸ ì†¡íŒŒêµ¬ ì˜¬ë¦¼í”½ë¡œ 300', 'ì„œìš¸ ì†¡íŒŒêµ¬ ì‹ ì²œë™ 29', '1661-2000']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ê´€ë¦¬ì‚¬ë¬´ì†Œì •ë³´');
            
            XLSX.writeFile(wb, 'ê´€ë¦¬ì‚¬ë¬´ì†Œì •ë³´_ìƒ˜í”Œ.xlsx');
            showToast('ìƒ˜í”Œ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        };
        
        // íŒŒì¼ëª…ìš© ë‚ ì§œ í¬ë§·
        function formatDateForFile(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${year}${month}${day}_${hours}${minutes}`;
        }
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        
        // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adminLogin();
            }
        });
    </script>
</body>
</html>