<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹Œë”© ì¢Œí‘œ ë³€í™˜ê¸°</title>
    
    <!-- ì¹´ì¹´ì˜¤ë§µ API - ë³¸ì¸ì˜ API í‚¤ë¡œ êµì²´í•˜ì„¸ìš” -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1ac6eee9b1e4c2e0cc6f1d1ca1a6a559&libraries=services"></script>
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .control-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.success {
            background: #28a745;
        }
        
        .button.success:hover {
            background: #218838;
        }
        
        .button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .button.warning:hover {
            background: #e0a800;
        }
        
        .button.danger {
            background: #dc3545;
        }
        
        .button.danger:hover {
            background: #c82333;
        }
        
        .progress-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .status-text {
            text-align: center;
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .log-section {
            margin-top: 30px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-item.success {
            background: #d4edda;
            color: #155724;
        }
        
        .log-item.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-item.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .preview-section {
            margin-top: 30px;
            display: none;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .preview-table th,
        .preview-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .preview-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .coords-success {
            color: #28a745;
            font-weight: bold;
        }
        
        .coords-error {
            color: #dc3545;
        }
        
        .api-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .api-selector label {
            margin-right: 20px;
        }
        
        .file-info {
            padding: 15px;
            background: #e3f2fd;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .warning-box {
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            color: #856404;
            margin-bottom: 20px;
        }
        
        /* ì‹¤íŒ¨í•œ ë¹Œë”© ë¦¬ìŠ¤íŠ¸ */
        .failed-buildings-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff5f5;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            display: none;
        }
        
        .failed-buildings-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .failed-building-item {
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .manual-coords-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        .manual-coords-input input {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 120px;
        }
        
        .manual-coords-input button {
            padding: 5px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .manual-coords-input button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ ë¹Œë”© ì¢Œí‘œ ë³€í™˜ê¸°</h1>
        
        <div class="warning-box">
            âš ï¸ ì£¼ì˜: ì´ ë„êµ¬ëŠ” ê¹ƒí—ˆë¸Œ í˜ì´ì§€ì—ì„œ buildings.json íŒŒì¼ì„ ì½ì–´ì™€ ì¢Œí‘œë¥¼ ë³€í™˜í•©ë‹ˆë‹¤.<br>
            ë³€í™˜ í›„ ìƒˆë¡œìš´ JSON íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ê¹ƒí—ˆë¸Œì— ë‹¤ì‹œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.
        </div>
        
        <div class="api-selector">
            <strong>API ì„¤ì •:</strong>
            <label>
                <input type="checkbox" id="cleanAddress" checked> ì£¼ì†Œ ì •ë¦¬ (ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
            </label>
            <label>
                <input type="checkbox" id="tryJibun" checked> ë„ë¡œëª… ì‹¤íŒ¨ ì‹œ ì§€ë²ˆ ì£¼ì†Œ ì‹œë„
            </label>
            <label>
                <input type="checkbox" id="tryBuildingName"> ë¹Œë”©ëª…ìœ¼ë¡œë„ ê²€ìƒ‰ ì‹œë„
            </label>
        </div>
        
        <div class="control-panel">
            <button class="button" onclick="loadBuildingsData()">
                ğŸ“ buildings.json ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
            <button class="button success" id="startBtn" onclick="startGeocoding()" disabled>
                ğŸš€ ì¢Œí‘œ ë³€í™˜ ì‹œì‘
            </button>
            <button class="button warning" id="pauseBtn" onclick="pauseGeocoding()" style="display: none;">
                â¸ï¸ ì¼ì‹œì •ì§€
            </button>
            <button class="button danger" id="retryFailedBtn" onclick="retryFailedBuildings()" style="display: none;">
                ğŸ”„ ì‹¤íŒ¨í•œ ë¹Œë”©ë§Œ ì¬ì‹œë„
            </button>
            <button class="button success" id="downloadBtn" onclick="downloadJSON()" disabled>
                ğŸ’¾ ë³€í™˜ëœ JSON ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
        
        <div class="file-info" id="fileInfo"></div>
        
        <div class="progress-section" style="display: none;" id="progressSection">
            <div class="status-text" id="statusText">ì¤€ë¹„ ì¤‘...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">ì „ì²´ ë¹Œë”©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="needsCount">0</div>
                    <div class="stat-label">ë³€í™˜ í•„ìš”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successCount">0</div>
                    <div class="stat-label">ë³€í™˜ ì„±ê³µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="errorCount">0</div>
                    <div class="stat-label">ë³€í™˜ ì‹¤íŒ¨</div>
                </div>
            </div>
        </div>
        
        <!-- ì‹¤íŒ¨í•œ ë¹Œë”© ìˆ˜ë™ ì…ë ¥ ì„¹ì…˜ -->
        <div class="failed-buildings-section" id="failedBuildingsSection">
            <h3>âŒ ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨ ë¹Œë”© (ìˆ˜ë™ ì…ë ¥ ê°€ëŠ¥)</h3>
            <p>ì•„ë˜ ë¹Œë”©ë“¤ì€ ìë™ ë³€í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì£¼ì†Œë¥¼ ìˆ˜ì • í›„ ì¬ì‹œë„í•˜ì„¸ìš”.</p>
            <div class="failed-buildings-list" id="failedBuildingsList"></div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3>ë¯¸ë¦¬ë³´ê¸° (ìµœê·¼ ë³€í™˜ëœ 10ê°œ)</h3>
            <table class="preview-table" id="previewTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë¹Œë”©ëª…</th>
                        <th>ì£¼ì†Œ</th>
                        <th>ìœ„ë„</th>
                        <th>ê²½ë„</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="previewBody"></tbody>
            </table>
        </div>
        
        <div class="log-section">
            <h3>ë³€í™˜ ë¡œê·¸</h3>
            <div id="logContainer"></div>
        </div>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let buildingsData = [];
        let geocoder = null;
        let isGeocoding = false;
        let isPaused = false;
        let currentIndex = 0;
        let successCount = 0;
        let errorCount = 0;
        let convertedData = [];
        let failedBuildings = [];
        let apiDelay = 300; // API í˜¸ì¶œ ê°„ê²©ì„ 300msë¡œ ì¦ê°€
        
        // ìˆ˜ë™ ì…ë ¥í•œ ì¢Œí‘œ ì €ì¥ì†Œ
        const manualCoords = {
            "êµ¬ë¯¸ë™ 192-3 ì—…ë¬´ì‹œì„¤": { lat: 37.339700, lng: 127.105800 },
            "ì„±ë¬¸ë¹Œë”©": { lat: 37.487230, lng: 127.033780 },
            "WìŠ¤í€˜ì–´": { lat: 37.544810, lng: 127.056170 },
            "ì•µì»¤ì›(Anchor1)": { lat: 37.521710, lng: 126.928470 },
            "ì„ì§€íŠ¸ìœˆíƒ€ì›Œ Aë™(WEST)": { lat: 37.567180, lng: 126.990940 }
        };
        
        // ì´ˆê¸°í™”
        window.onload = function() {
            // ì¹´ì¹´ì˜¤ ì§€ì˜¤ì½”ë” ì´ˆê¸°í™”
            geocoder = new kakao.maps.services.Geocoder();
        };
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            logItem.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // buildings.json íŒŒì¼ ë¡œë“œ
        async function loadBuildingsData() {
            try {
                addLog('buildings.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
                
                const response = await fetch('./data/buildings.json');
                if (!response.ok) {
                    throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const data = await response.json();
                buildingsData = data.buildings || [];
                
                // íŒŒì¼ ì •ë³´ í‘œì‹œ
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <strong>íŒŒì¼ ì •ë³´:</strong><br>
                    ì´ ë¹Œë”© ìˆ˜: ${buildingsData.length}ê°œ<br>
                    ì¢Œí‘œ ë³€í™˜ í•„ìš”: ${buildingsData.filter(b => !b.lat || !b.lng).length}ê°œ<br>
                    ì´ë¯¸ ì¢Œí‘œ ìˆìŒ: ${buildingsData.filter(b => b.lat && b.lng).length}ê°œ
                `;
                
                addLog(`âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${buildingsData.length}ê°œ ë¹Œë”©`, 'success');
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
                
                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('startBtn').disabled = false;
                
            } catch (error) {
                addLog(`âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                alert('buildings.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\níŒŒì¼ì´ data í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const needsGeocode = buildingsData.filter(b => !b.lat || !b.lng);
            
            document.getElementById('totalCount').textContent = buildingsData.length;
            document.getElementById('needsCount').textContent = needsGeocode.length;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('errorCount').textContent = errorCount;
        }
        
        // ì£¼ì†Œ ì •ë¦¬ í•¨ìˆ˜
        function cleanAddress(address) {
            if (!address) return '';
            
            // ëì— ìˆëŠ” ê³µë°± ì œê±°
            address = address.trim();
            
            // ì¤‘ë³µ ê³µë°± ì œê±°
            address = address.replace(/\s+/g, ' ');
            
            // íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬
            address = address.replace(/[""]/g, '"');
            address = address.replace(/['']/g, "'");
            
            return address;
        }
        
        // ì¢Œí‘œ ë³€í™˜ ì‹œì‘
        async function startGeocoding() {
            if (buildingsData.length === 0) {
                alert('ë¨¼ì € buildings.json íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¢Œí‘œê°€ ì—†ëŠ” ë¹Œë”©ë§Œ í•„í„°ë§
            const needsGeocode = buildingsData.filter(b => !b.lat || !b.lng);
            
            if (needsGeocode.length === 0) {
                alert('ëª¨ë“  ë¹Œë”©ì´ ì´ë¯¸ ì¢Œí‘œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('previewSection').style.display = 'block';
            
            isGeocoding = true;
            isPaused = false;
            currentIndex = 0;
            successCount = 0;
            errorCount = 0;
            failedBuildings = [];
            convertedData = [...buildingsData]; // ì „ì²´ ë°ì´í„° ë³µì‚¬
            
            addLog(`ğŸš€ ì¢Œí‘œ ë³€í™˜ ì‹œì‘: ${needsGeocode.length}ê°œ ë¹Œë”©`, 'info');
            
            // ë³€í™˜ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            await processGeocoding(needsGeocode);
        }
        
        // ì¢Œí‘œ ë³€í™˜ í”„ë¡œì„¸ìŠ¤
        async function processGeocoding(buildings) {
            for (let i = currentIndex; i < buildings.length; i++) {
                if (!isGeocoding || isPaused) break;
                
                currentIndex = i;
                const building = buildings[i];
                const progress = Math.round((i + 1) / buildings.length * 100);
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateProgress(progress, `${i + 1}/${buildings.length} ì²˜ë¦¬ ì¤‘...`);
                
                // ë¨¼ì € ìˆ˜ë™ ì…ë ¥ëœ ì¢Œí‘œê°€ ìˆëŠ”ì§€ í™•ì¸
                if (manualCoords[building.name]) {
                    const coords = manualCoords[building.name];
                    const originalIndex = convertedData.findIndex(b => b.id === building.id);
                    if (originalIndex !== -1) {
                        convertedData[originalIndex].lat = coords.lat;
                        convertedData[originalIndex].lng = coords.lng;
                        convertedData[originalIndex].needsGeocode = false;
                        convertedData[originalIndex].geocodeDate = new Date().toISOString();
                        convertedData[originalIndex].geocodeMethod = 'manual';
                    }
                    
                    successCount++;
                    addLog(`âœ… [${building.id}] ${building.name}: ${coords.lat}, ${coords.lng} (ìˆ˜ë™ ì…ë ¥)`, 'success');
                    updatePreview(building, coords, 'success');
                    
                    await delay(50); // ì§§ì€ ë”œë ˆì´
                    continue;
                }
                
                let success = false;
                let finalCoords = null;
                
                // 1ì°¨ ì‹œë„: ë„ë¡œëª… ì£¼ì†Œ
                if (building.address && document.getElementById('cleanAddress').checked) {
                    const cleanedAddress = cleanAddress(building.address);
                    try {
                        const coords = await geocodeAddress(cleanedAddress);
                        if (coords) {
                            success = true;
                            finalCoords = coords;
                            addLog(`âœ… [${building.id}] ${building.name}: ë„ë¡œëª… ì£¼ì†Œë¡œ ì„±ê³µ`, 'success');
                        }
                    } catch (error) {
                        addLog(`âš ï¸ [${building.id}] ${building.name}: ë„ë¡œëª… ì£¼ì†Œ ì‹¤íŒ¨`, 'info');
                    }
                }
                
                // 2ì°¨ ì‹œë„: ì§€ë²ˆ ì£¼ì†Œ
                if (!success && building.addressJibun && document.getElementById('tryJibun').checked) {
                    const cleanedJibun = cleanAddress(building.addressJibun);
                    try {
                        const coords = await geocodeAddress(cleanedJibun);
                        if (coords) {
                            success = true;
                            finalCoords = coords;
                            addLog(`âœ… [${building.id}] ${building.name}: ì§€ë²ˆ ì£¼ì†Œë¡œ ì„±ê³µ`, 'success');
                        }
                    } catch (error) {
                        addLog(`âš ï¸ [${building.id}] ${building.name}: ì§€ë²ˆ ì£¼ì†Œ ì‹¤íŒ¨`, 'info');
                    }
                }
                
                // 3ì°¨ ì‹œë„: ë¹Œë”©ëª… + ì§€ì—­
                if (!success && document.getElementById('tryBuildingName').checked) {
                    const addressParts = (building.address || building.addressJibun || '').split(' ');
                    const region = addressParts.slice(0, 2).join(' '); // ì‹œ/êµ¬ ì •ë³´
                    const searchQuery = `${region} ${building.name}`;
                    
                    try {
                        const coords = await geocodeAddress(searchQuery);
                        if (coords) {
                            success = true;
                            finalCoords = coords;
                            addLog(`âœ… [${building.id}] ${building.name}: ë¹Œë”©ëª… ê²€ìƒ‰ìœ¼ë¡œ ì„±ê³µ`, 'success');
                        }
                    } catch (error) {
                        addLog(`âš ï¸ [${building.id}] ${building.name}: ë¹Œë”©ëª… ê²€ìƒ‰ ì‹¤íŒ¨`, 'info');
                    }
                }
                
                // ê²°ê³¼ ì²˜ë¦¬
                if (success && finalCoords) {
                    const originalIndex = convertedData.findIndex(b => b.id === building.id);
                    if (originalIndex !== -1) {
                        convertedData[originalIndex].lat = finalCoords.lat;
                        convertedData[originalIndex].lng = finalCoords.lng;
                        convertedData[originalIndex].needsGeocode = false;
                        convertedData[originalIndex].geocodeDate = new Date().toISOString();
                    }
                    
                    successCount++;
                    addLog(`âœ… [${building.id}] ${building.name}: ${finalCoords.lat}, ${finalCoords.lng}`, 'success');
                    updatePreview(building, finalCoords, 'success');
                } else {
                    errorCount++;
                    failedBuildings.push(building);
                    
                    const originalIndex = convertedData.findIndex(b => b.id === building.id);
                    if (originalIndex !== -1) {
                        convertedData[originalIndex].geocodeError = true;
                        convertedData[originalIndex].geocodeErrorMsg = 'ëª¨ë“  ë°©ë²•ìœ¼ë¡œ ì¢Œí‘œ ê²€ìƒ‰ ì‹¤íŒ¨';
                    }
                    
                    addLog(`âŒ [${building.id}] ${building.name}: ëª¨ë“  ì‹œë„ ì‹¤íŒ¨`, 'error');
                    updatePreview(building, null, 'error');
                }
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                updateStats();
                
                // API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ ë”œë ˆì´
                await delay(apiDelay);
            }
            
            // ì™„ë£Œ ì²˜ë¦¬
            if (currentIndex >= buildings.length - 1) {
                completeGeocoding();
            }
        }
        
        // ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜ (ì¹´ì¹´ì˜¤ API)
        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                if (!address) {
                    reject('ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                geocoder.addressSearch(address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK && result.length > 0) {
                        resolve({
                            lat: parseFloat(result[0].y),
                            lng: parseFloat(result[0].x)
                        });
                    } else {
                        reject(`ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ${status}`);
                    }
                });
            });
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percent, statusText) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('statusText').textContent = statusText;
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview(building, coords, status) {
            const previewBody = document.getElementById('previewBody');
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${building.id}</td>
                <td>${building.name}</td>
                <td>${building.address}</td>
                <td class="${status === 'success' ? 'coords-success' : 'coords-error'}">
                    ${coords ? coords.lat.toFixed(6) : 'ERROR'}
                </td>
                <td class="${status === 'success' ? 'coords-success' : 'coords-error'}">
                    ${coords ? coords.lng.toFixed(6) : 'ERROR'}
                </td>
                <td>${status === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}</td>
            `;
            
            // ìµœì‹  í•­ëª©ì„ ìœ„ì— ì¶”ê°€
            previewBody.insertBefore(row, previewBody.firstChild);
            
            // 10ê°œë§Œ ìœ ì§€
            while (previewBody.children.length > 10) {
                previewBody.removeChild(previewBody.lastChild);
            }
        }
        
        // ë³€í™˜ ì™„ë£Œ
        function completeGeocoding() {
            isGeocoding = false;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('downloadBtn').disabled = false;
            
            updateProgress(100, 'âœ… ë³€í™˜ ì™„ë£Œ!');
            addLog(`ğŸ‰ ë³€í™˜ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${errorCount}ê°œ`, 'success');
            
            // ë³€í™˜ ê²°ê³¼ ìš”ì•½
            const summary = {
                total: buildingsData.length,
                success: successCount,
                error: errorCount,
                hasCoords: convertedData.filter(b => b.lat && b.lng).length
            };
            
            addLog(`ğŸ“Š ìµœì¢… ê²°ê³¼: ì „ì²´ ${summary.total}ê°œ ì¤‘ ${summary.hasCoords}ê°œê°€ ì¢Œí‘œë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.`, 'info');
            
            // ì‹¤íŒ¨í•œ ë¹Œë”©ì´ ìˆìœ¼ë©´ ìˆ˜ë™ ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
            if (failedBuildings.length > 0) {
                showFailedBuildings();
                document.getElementById('retryFailedBtn').style.display = 'inline-block';
            }
        }
        
        // ì‹¤íŒ¨í•œ ë¹Œë”© í‘œì‹œ
        function showFailedBuildings() {
            const section = document.getElementById('failedBuildingsSection');
            const list = document.getElementById('failedBuildingsList');
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            failedBuildings.forEach((building, index) => {
                const item = document.createElement('div');
                item.className = 'failed-building-item';
                item.innerHTML = `
                    <strong>${building.name}</strong> (ID: ${building.id})<br>
                    <small>ë„ë¡œëª…: ${building.address || 'N/A'}</small><br>
                    <small>ì§€ë²ˆ: ${building.addressJibun || 'N/A'}</small>
                    <div class="manual-coords-input">
                        <input type="text" id="lat-${building.id}" placeholder="ìœ„ë„ (ì˜ˆ: 37.5665)" />
                        <input type="text" id="lng-${building.id}" placeholder="ê²½ë„ (ì˜ˆ: 126.9780)" />
                        <button onclick="saveManualCoords(${building.id})">ì €ì¥</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // ìˆ˜ë™ ì¢Œí‘œ ì €ì¥
        function saveManualCoords(buildingId) {
            const latInput = document.getElementById(`lat-${buildingId}`);
            const lngInput = document.getElementById(`lng-${buildingId}`);
            
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('ì˜¬ë°”ë¥¸ ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì¢Œí‘œ ì €ì¥
            const originalIndex = convertedData.findIndex(b => b.id === buildingId);
            if (originalIndex !== -1) {
                convertedData[originalIndex].lat = lat;
                convertedData[originalIndex].lng = lng;
                convertedData[originalIndex].needsGeocode = false;
                convertedData[originalIndex].geocodeDate = new Date().toISOString();
                convertedData[originalIndex].geocodeMethod = 'manual';
                convertedData[originalIndex].geocodeError = false;
                
                // ì‹¤íŒ¨ ëª©ë¡ì—ì„œ ì œê±°
                failedBuildings = failedBuildings.filter(b => b.id !== buildingId);
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                successCount++;
                errorCount--;
                updateStats();
                
                addLog(`âœ… [${buildingId}] ìˆ˜ë™ ì¢Œí‘œ ì…ë ¥ ì™„ë£Œ: ${lat}, ${lng}`, 'success');
                
                // UI ì—…ë°ì´íŠ¸
                if (failedBuildings.length === 0) {
                    document.getElementById('failedBuildingsSection').style.display = 'none';
                    document.getElementById('retryFailedBtn').style.display = 'none';
                } else {
                    showFailedBuildings();
                }
            }
        }
        
        // ì‹¤íŒ¨í•œ ë¹Œë”© ì¬ì‹œë„
        async function retryFailedBuildings() {
            if (failedBuildings.length === 0) {
                alert('ì¬ì‹œë„í•  ë¹Œë”©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            document.getElementById('retryFailedBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            
            isGeocoding = true;
            isPaused = false;
            currentIndex = 0;
            
            const buildingsToRetry = [...failedBuildings];
            failedBuildings = [];
            
            addLog(`ğŸ”„ ì‹¤íŒ¨í•œ ë¹Œë”© ${buildingsToRetry.length}ê°œ ì¬ì‹œë„`, 'info');
            
            await processGeocoding(buildingsToRetry);
        }
        
        // ì¼ì‹œì •ì§€
        function pauseGeocoding() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.textContent = 'â–¶ï¸ ì¬ê°œ';
                pauseBtn.classList.remove('warning');
                pauseBtn.classList.add('success');
                addLog('â¸ï¸ ë³€í™˜ ì¼ì‹œì •ì§€', 'info');
            } else {
                pauseBtn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
                pauseBtn.classList.remove('success');
                pauseBtn.classList.add('warning');
                addLog('â–¶ï¸ ë³€í™˜ ì¬ê°œ', 'info');
                
                // ì¬ê°œ ì‹œ ì´ì–´ì„œ ì²˜ë¦¬
                const needsGeocode = buildingsData.filter(b => !b.lat || !b.lng);
                processGeocoding(needsGeocode);
            }
        }
        
        // JSON ë‹¤ìš´ë¡œë“œ
        function downloadJSON() {
            if (convertedData.length === 0) {
                alert('ë³€í™˜ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ìµœì¢… ë°ì´í„° êµ¬ì„±
            const outputData = {
                metadata: {
                    totalCount: convertedData.length,
                    lastUpdated: new Date().toISOString(),
                    version: '2.0',
                    geocodeInfo: {
                        successCount: successCount,
                        errorCount: errorCount,
                        hasCoords: convertedData.filter(b => b.lat && b.lng).length,
                        manuallyAdded: convertedData.filter(b => b.geocodeMethod === 'manual').length
                    }
                },
                buildings: convertedData
            };
            
            // JSON íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
            const dataStr = JSON.stringify(outputData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `buildings_with_coords_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            addLog('ğŸ’¾ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
            
            // ì‚¬ìš© ì•ˆë‚´
            setTimeout(() => {
                alert('ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\n' +
                      'ë‹¤ìŒ ë‹¨ê³„:\n' +
                      '1. ë‹¤ìš´ë¡œë“œëœ JSON íŒŒì¼ì„ ê¹ƒí—ˆë¸Œ data í´ë”ì— ì—…ë¡œë“œí•˜ì„¸ìš”.\n' +
                      '2. ê¸°ì¡´ buildings.jsonì„ ë°±ì—…í•˜ê³  ìƒˆ íŒŒì¼ë¡œ êµì²´í•˜ì„¸ìš”.\n' +
                      '3. index.htmlì—ì„œ ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì˜ ë¡œë“œë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }, 500);
        }
        
        // ë”œë ˆì´ í•¨ìˆ˜
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>